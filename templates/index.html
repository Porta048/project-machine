<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engine Health Check - Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: #fff;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            font-size: 2.2em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            color: #7f8c8d;
        }

        .main-content {
            background: #fff;
            border-radius: 8px;
            padding: 40px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .upload-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .upload-area {
            border: 2px dashed #3498db;
            border-radius: 8px;
            padding: 60px 20px;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: #2980b9;
            background: #e3f2fd;
        }

        .upload-area.dragover {
            border-color: #27ae60;
            background: #e8f5e8;
        }

        .upload-icon {
            font-size: 3em;
            color: #3498db;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.2em;
            color: #555;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .upload-subtext {
            color: #888;
            font-size: 0.9em;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            font-weight: 500;
        }

        .upload-btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .result-section {
            display: none;
            text-align: center;
            margin-top: 40px;
        }

        .result-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 40px;
            border: 1px solid #e9ecef;
            margin-bottom: 30px;
        }

        .result-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .result-title {
            font-size: 2em;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .result-good {
            color: #27ae60;
        }

        .result-bad {
            color: #e74c3c;
        }

        .result-description {
            font-size: 1.1em;
            color: #555;
            margin-bottom: 20px;
        }

        .confidence-bar {
            width: 100%;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .confidence-fill {
            height: 100%;
            transition: width 0.5s ease;
        }

        .confidence-fill.good {
            background: linear-gradient(90deg, #27ae60, #2ecc71);
        }

        .confidence-fill.bad {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
        }

        .confidence-text {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 10px;
        }

        .details-section {
            background: #fff;
            border-radius: 8px;
            padding: 25px;
            border: 1px solid #e9ecef;
            margin-top: 20px;
        }

        .details-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: left;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 500;
            color: #555;
        }

        .detail-value {
            font-weight: 600;
            color: #2c3e50;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            text-align: center;
            border: 1px solid #f5c6cb;
        }

        .simulation-warning, .quality-warning {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .warning-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            color: #856404;
        }

        .warning-icon {
            font-size: 1.5em;
            margin-right: 10px;
        }

        .warning-content p {
            margin-bottom: 10px;
            color: #856404;
        }

        .warning-content ul {
            list-style: none;
            padding-left: 20px;
            margin-bottom: 10px;
        }

        .warning-content li {
            margin-bottom: 5px;
            color: #856404;
        }

        .warning-content strong {
            color: #856404;
        }

        .info-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .info-section h3 {
            font-size: 1.4em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #f0f2f5;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .info-label {
            font-weight: 500;
            color: #555;
            font-size: 0.9em;
        }

        .info-value {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .anomalies-list {
            list-style: none;
            padding-left: 20px;
            margin-top: 10px;
        }

        .anomalies-list li {
            margin-bottom: 8px;
            color: #e74c3c;
            font-weight: 500;
        }
        
        .error-message, .warning-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .warning-message {
            background: #fff3cd;
            border: 1px solid #ffeeba;
        }
        
        .error-header, .warning-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            color: #721c24;
        }
        
        .warning-header {
            color: #856404;
        }
        
        .error-icon, .warning-icon {
            font-size: 1.5em;
            margin-right: 10px;
        }
        
        .error-content p, .warning-content p {
            margin-bottom: 10px;
            color: #721c24;
        }
        
        .warning-content p {
            color: #856404;
        }
        
        .detailed-info {
            margin-top: 30px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .container {
                padding: 10px;
            }
            
            .result-title {
                font-size: 1.6em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Engine Health Check - DEMO</h1>
            <p>Upload an engine image to check if it's in good condition (Demo Version)</p>
        </div>

        <div class="simulation-warning">
            <div class="warning-header">
                <span class="warning-icon">üöß</span>
                <strong>Demo Version</strong>
            </div>
            <div class="warning-content">
                <p><strong>This is a demonstration version of the Engine Health Check system.</strong></p>
                <p>Features:</p>
                <ul>
                    <li>‚úÖ Image analysis for visual defect detection</li>
                    <li>‚úÖ Simulated sensor data generation from images</li>
                    <li>‚úÖ RUL (Remaining Useful Life) prediction using trained models</li>
                    <li>‚ö†Ô∏è Results are for demonstration purposes only</li>
                </ul>
                <p><strong>Note:</strong> This demo uses simulated sensor data derived from image analysis. In a production environment, real sensor data would be used for more accurate predictions.</p>
            </div>
        </div>

        <div class="main-content">
            <div class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üì∑</div>
                    <div class="upload-text">Drag and drop engine image here or click to browse</div>
                    <div class="upload-subtext">
                        Supported formats: JPG, PNG, GIF, BMP (Max 16MB)
                    </div>
                </div>
                <input type="file" id="fileInput" class="file-input" accept="image/*">
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    Choose File
                </button>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Analyzing engine condition...</p>
            </div>

            <div class="result-section" id="resultSection">
                <div class="result-content">
                    <div class="result-header">
                        <div class="result-icon" id="resultIcon">‚úÖ</div>
                        <div class="result-text">
                            <h2 class="result-title" id="resultTitle">ENGINE IS GOOD</h2>
                            <p class="result-description" id="resultDescription">The engine appears to be in good condition.</p>
                        </div>
                    </div>
                    
                    <div class="confidence-section">
                    <div class="confidence-bar">
                            <div class="confidence-fill" id="confidenceFill"></div>
                        </div>
                        <span class="confidence-text" id="confidenceText">85%</span>
                    </div>
                    
                    <div id="detailed-info" class="detailed-info">
                        <!-- Detailed analysis information will be inserted here -->
                </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const loading = document.getElementById('loading');
        const resultSection = document.getElementById('resultSection');
        const resultIcon = document.getElementById('resultIcon');
        const resultTitle = document.getElementById('resultTitle');
        const resultDescription = document.getElementById('resultDescription');
        const confidenceFill = document.getElementById('confidenceFill');
        const confidenceText = document.getElementById('confidenceText');
        const analysisDetails = document.getElementById('analysisDetails');

        // Drag and drop functionality
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showError('Please select a valid image file.');
                return;
            }

            if (file.size > 16 * 1024 * 1024) {
                showError('File size must be less than 16MB.');
                return;
            }

            handleUpload(file);
        }

        function handleUpload(file) {
            const formData = new FormData();
            formData.append('file', file);

            // Optional: Add operational context
            const context = document.getElementById('operationalContext')?.value;
            if (context) {
                formData.append('operational_context', context);
            }

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                
                // Check for structured error response
                if (data.status === 'error') {
                    showError(`Error: ${data.error}`, data.details || 'Unknown error occurred');
                    return;
                }
                
                // Check for partial success
                if (data.status === 'partial_success') {
                    showWarning(data.message || 'Analysis completed with limitations');
                }
                
                // Display results
                displayResult(data);
            })
            .catch(error => {
                hideLoading();
                showError('Upload failed', error.message);
            });
        }
        
        function showError(title, message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `
                <div class="error-header">
                    <span class="error-icon">‚ùå</span>
                    <strong>${title}</strong>
                </div>
                <div class="error-content">
                    <p>${message}</p>
                </div>
            `;
            
            // Clear previous results and show error
            const resultSection = document.getElementById('resultSection');
            resultSection.innerHTML = '';
            resultSection.appendChild(errorDiv);
            resultSection.style.display = 'block';
            
            // Hide upload area
            document.getElementById('uploadArea').style.display = 'none';
        }
        
        function showWarning(message) {
            const warningDiv = document.createElement('div');
            warningDiv.className = 'warning-message';
            warningDiv.innerHTML = `
                <div class="warning-header">
                    <span class="warning-icon">‚ö†Ô∏è</span>
                    <strong>Warning</strong>
                </div>
                <div class="warning-content">
                    <p>${message}</p>
                </div>
            `;
            
            // Insert warning at the top of results
            const resultSection = document.getElementById('resultSection');
            resultSection.insertBefore(warningDiv, resultSection.firstChild);
        }

        function displayResult(data) {
            const visual = data.image_analysis;
            const sensor = data.sensor_prediction;
            
            // Check for simulation warnings
            if (data.sensor_data_info && data.sensor_data_info.simulation_info) {
                showSimulationWarning(data.sensor_data_info.simulation_info);
            }
            
            // Check analysis quality
            if (visual.analysis_quality === 'limited' || visual.analysis_quality === 'error') {
                showAnalysisQualityWarning(visual.analysis_quality);
            }
            
            // Determine overall engine condition
            let isGood = true;
            let confidence = 0;
            let reasons = [];
            
            // Check visual assessment
            if (visual.visual_assessment === 'Poor') {
                isGood = false;
                reasons.push('Visual defects detected');
            }
            
            // Check sensor prediction
            if (typeof sensor.rul === 'number') {
                if (sensor.rul <= 20) {
                    isGood = false;
                    reasons.push('Critical RUL prediction');
                } else if (sensor.rul <= 50) {
                    reasons.push('Low RUL warning');
                }
            }
            
            // Calculate confidence
            confidence = Math.round(visual.confidence * 100);
            
            // Display result
            if (isGood) {
                resultIcon.textContent = '‚úÖ';
                resultIcon.className = 'result-icon result-good';
                resultTitle.textContent = 'ENGINE IS GOOD';
                resultTitle.className = 'result-title result-good';
                resultDescription.textContent = 'The engine appears to be in good condition based on visual and sensor analysis.';
                confidenceFill.className = 'confidence-fill good';
            } else {
                resultIcon.textContent = '‚ùå';
                resultIcon.className = 'result-icon result-bad';
                resultTitle.textContent = 'ENGINE NEEDS ATTENTION';
                resultTitle.className = 'result-title result-bad';
                resultDescription.textContent = 'The engine shows signs of issues that require attention.';
                confidenceFill.className = 'confidence-fill bad';
            }
            
            // Update confidence bar
            confidenceFill.style.width = confidence + '%';
            confidenceText.textContent = confidence + '%';
            
            // Display detailed information
            displayDetailedInfo(visual, sensor, data);
            
            // Show results
            resultSection.style.display = 'block';
            uploadArea.style.display = 'none';
        }
        
                 function showSimulationWarning(simulationInfo) {
             const warningDiv = document.createElement('div');
             warningDiv.className = 'simulation-warning';
             warningDiv.innerHTML = `
                 <div class="warning-header">
                     <span class="warning-icon">‚ö†Ô∏è</span>
                     <strong>Simulation Warning</strong>
                 </div>
                 <div class="warning-content">
                     <p><strong>${simulationInfo.warning}</strong></p>
                     <p><strong>Limitations:</strong></p>
                     <ul>
                         ${simulationInfo.limitations.map(lim => `<li>${lim}</li>`).join('')}
                     </ul>
                     <p><strong>For Production Use:</strong></p>
                     <ul>
                         ${simulationInfo.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                     </ul>
                 </div>
             `;
             
             // Insert warning before results
             const resultsSection = document.querySelector('.result-section');
             resultsSection.insertBefore(warningDiv, resultsSection.firstChild);
         }
        
                 function showAnalysisQualityWarning(quality) {
             const warningDiv = document.createElement('div');
             warningDiv.className = 'quality-warning';
             
             let message = '';
             if (quality === 'limited') {
                 message = 'Some image analysis components failed. Results may be incomplete.';
             } else if (quality === 'error') {
                 message = 'Image analysis encountered errors. Results are limited.';
             }
             
             warningDiv.innerHTML = `
                 <div class="warning-header">
                     <span class="warning-icon">‚ö†Ô∏è</span>
                     <strong>Analysis Quality Warning</strong>
                 </div>
                 <div class="warning-content">
                     <p>${message}</p>
                 </div>
             `;
             
             // Insert warning before results
             const resultsSection = document.querySelector('.result-section');
             resultsSection.insertBefore(warningDiv, resultsSection.firstChild);
         }
        
                 function displayDetailedInfo(visual, sensor, data) {
             const detailsContainer = document.getElementById('detailed-info');
            
            let detailsHTML = `
                <div class="info-section">
                    <h3>üìä Visual Analysis</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Image Size:</span>
                            <span class="info-value">${visual.image_size[1]}x${visual.image_size[0]}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Brightness:</span>
                            <span class="info-value">${visual.brightness.toFixed(1)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Contrast:</span>
                            <span class="info-value">${visual.contrast.toFixed(1)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Edge Density:</span>
                            <span class="info-value">${visual.edge_density.toFixed(4)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Visual Assessment:</span>
                            <span class="info-value ${visual.visual_assessment.toLowerCase()}">${visual.visual_assessment}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Analysis Quality:</span>
                            <span class="info-value ${visual.analysis_quality}">${visual.analysis_quality}</span>
                        </div>
                    </div>
                </div>
                
                <div class="info-section">
                    <h3>‚ö° Sensor Prediction</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Dataset Used:</span>
                            <span class="info-value">${sensor.dataset}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">RUL Prediction:</span>
                            <span class="info-value">${typeof sensor.rul === 'number' ? sensor.rul.toFixed(1) + ' cycles' : sensor.rul}</span>
                        </div>
            `;
            
            // Add selection reason if available
            if (sensor.selection_reason) {
                detailsHTML += `
                        <div class="info-item">
                            <span class="info-label">Selection Reason:</span>
                            <span class="info-value">${sensor.selection_reason.reason}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Selection Confidence:</span>
                            <span class="info-value">${(sensor.selection_reason.confidence * 100).toFixed(0)}%</span>
                    </div>
                `;
            }
            
            // Add user context if specified
            if (sensor.user_context) {
                detailsHTML += `
                        <div class="info-item">
                            <span class="info-label">User Context:</span>
                            <span class="info-value">${sensor.user_context}</span>
                    </div>
                `;
            }
            
            detailsHTML += `
                    </div>
                </div>
            `;
            
            // Add anomalies if any
            if (visual.anomalies_detected && visual.anomalies_detected.length > 0) {
                detailsHTML += `
                    <div class="info-section">
                        <h3>üö® Anomalies Detected</h3>
                        <ul class="anomalies-list">
                            ${visual.anomalies_detected.map(anomaly => `<li>${anomaly}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            detailsContainer.innerHTML = detailsHTML;
        }

        function hideLoading() {
            loading.style.display = 'none';
        }
    </script>
</body>
</html>